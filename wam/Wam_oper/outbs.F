      SUBROUTINE OUTBS (FL3, FL, IJS, IJL, IG, IGL, IU25, IU26)
! ----------------------------------------------------------------------

!**** *OUTBS* - MODEL OUTPUT FROM BLOCK TO FILE, PRINTER AND COMMON.

!     H. GUNTHER         GKSS/ECMWF         JUNE 1990
!     J. BIDLOT          ECMWF   FEBRUARY 1996 MESSAGE PASSING
!     D. PETTENUZZO      MAY 2012 ADDED 3 TRAIN DECOMPOSITION CALL

!*    PURPOSE.
!     --------

!       CONTROL OUTPUT OF WAVE AND WIND FIELDS.


!**   INTERFACE.
!     ----------
!   *CALL* *OUTBS (FL3, FL, IJS, IJL, IG, IGL, IU25, IU26)
!      *FL3*    - SPECTRUM.
!      *FL*     - WORKING ARRAY FOR SWELL OUTPUT.
!      *IJS*    - INDEX OF FIRST GRIDPOINT
!      *IJL*    - INDEX OF LAST GRIDPOINT
!      *IG*     - BLOCK NUMBER
!      *IGL*    - TOTAL NUMBER OF BLOCKS.
!      *IU25*   - OUTPUT UNIT FOR SPECTRA.
!      *IU26*   - OUTPUT UNIT FOR SEA AND SWELL SPECTRA.

!     EXTERNALS.
!     ----------

!       *FEMEAN*    - COMPUTATION OF MEAN FREQUENCY AT EACH GRID POINT.
!       *OUTERS*    - OUTPUT OF SATELLITE COLOCATION SPECTRA.
!       *OUTGRID*   - SAVE BLOCKED PARAMETERS INTO GRID ARRAYS.
!       *OUTSPP*    - OUTPUT OF SPECTRA AT SELECTED POINTS.
!       *SEMEAN*    - COMPUTATION OF TOTAL ENERGY AT EACH GRID POINT.
!       *SEPWISW*   - SEPARATION OF WINDSEA AND SWELL.
!       *SEP3TR*    - SEPARATION OF WAVE SPECTRA INTO 3 WAVE TRAINS
!       *STHQ*      - COMPUTATION OF MEAN WAVE DIRECTION AT EACH
!                     GRID POINT.
!       *MWP1*      - COMPUTATION OF MEAN PERIOD (1) AT EACH GRID POINT.
!       *MWP2*      - COMPUTATION OF MEAN PERIOD (2) AT EACH GRID POINT.
!       *WDIRSPREAD*- COMPUTATION OF MEAN DIRECTIONAL SPREAD AT EACH 
!                     GRID POINT. 
!       *KURTOSIS*  - COMPUTATION OF THE SURFACE ELEVATION KURTOSIS, 
!                     THE BEJAMIN-FEIR INDEX, THE SPECTRAL PEAKEDNESS 
!                     FACTOR AND THE MAXIMUM WAVE HEIGHT.
!       *STOKESDRIFT*  - COMPUTATION OF THE STOKES DRIFT VECTOR. 
!   
!     METHOD.
!     -------

!       NONE.

!     REFERENCE.
!     ----------

!       NONE.

! ----------------------------------------------------------------------
      USE YOWCOUT  , ONLY : JPPFLAG  ,IPFGTBL  ,LSECONDORDER
      USE YOWINTP  , ONLY : WHGTTG   ,WDIRTG   ,WPKFTG   ,WMNFTG   ,
     &            USTARG   ,UDIRG    ,TAUWG    ,CDG      ,SMEANG   ,
     &            U10G     ,WHGTAG   ,CWHTAG   ,RANGAG   ,MWP1G    ,
     &            MWP2G    ,WSPRDG   ,C4G      ,BFG      ,QPG      ,
     &            DEPTHG   ,HMAXG    ,TMAXG    ,USTOKESG ,VSTOKESG ,
     &            UCURG    ,VCURG    ,PHIEPSG  ,PHIAWG   ,TAUOCG   ,
     &            STRNMSG  ,RHOAG    ,WSTARG   ,CICG     ,CIHG     ,
     &            WX1G     ,WX2G     ,WX3G     ,WX4G     ,WX5G
      USE YOWINTS  , ONLY : WHGTSG   ,WDIRSG   ,WMNFSG   ,WHGTWG   ,
     &            WDIRWG   ,WMNFWG   ,MWP1SG   ,MWP2SG   ,WSPRDSG  ,
     &            MWP1WG   ,MWP2WG   ,WSPRDWG
      USE YOWINTT  , ONLY : WHGTT1G  ,WDIRT1G  ,MWP1T1G  ,
     &                      WHGTT2G  ,WDIRT2G  ,MWP1T2G  ,
     &                      WHGTT3G  ,WDIRT3G  ,MWP1T3G
      USE YOWMEAN  , ONLY : EMEAN    ,FMEAN    ,THQ      ,
     &            SMEAN    ,P1MEAN   ,P2MEAN   ,SPRDMEAN ,C4MEAN   ,
     &            BFMEAN   ,QPMEAN   ,HMAXMEAN ,FPMEAN   ,TMAXMEAN ,
     &            USTMEAN  ,VSTMEAN  ,PHIEPS   ,PHIAW    ,TAUOC    ,
     &            STRNMS   ,
     &            WX1      ,WX2      ,WX3      ,WX4      ,WX5
      USE YOWMPP   , ONLY : NPROC    ,NINF     ,NSUP
      USE YOWSPEC  , ONLY : NSTART   ,NEND     , 
     &            U10NEW   ,THWNEW   ,THWOLD   ,USNEW    ,USOLD
      USE YOWPARAM , ONLY : NGX      ,NGY      ,NANG     ,NFRE     ,
     &            NBLO
      USE YOWSHAL, ONLY: DEPTH,INDEP
      USE YOWSTAT  , ONLY : CDATEA   ,CDTPRO   ,CDTINTS  ,CDTSPT   ,
     &            CDTSPS   ,MARSTYPE ,NWAM_BLKS
      USE YOWSWEL  , ONLY : ESWELL   ,FSWELL   ,THSWELL  ,ESEA     ,
     &            FSEA     ,THWISEA  ,P1SWELL  ,P2SWELL  ,SPRDSWELL,
     &            P1SEA    ,P2SEA    ,SPRDSEA
      USE YOWTRAINS , ONLY: ETRAIN1  ,THTRAIN1 ,P1TRAIN1 ,
     &                      ETRAIN2  ,THTRAIN2 ,P1TRAIN2 ,
     &                      ETRAIN3  ,THTRAIN3 ,P1TRAIN3
      USE YOWTEST  , ONLY : IU06     ,ITEST    ,ITESTB
      USE YOMHOOK   ,ONLY : LHOOK,   DR_HOOK

! ----------------------------------------------------------------------

!     ALLOCATABLE ARRAYS THAT ARE PASSED AS SUBROUTINE ARGUMENTS 

! Mod for OPENMP
      INTEGER JKGLO,KIJS,KIJL,NPROMA
! End Mod for OPENMP

      REAL,DIMENSION(NINF-1:NSUP,NANG,NFRE) :: FL3, FL

      LOGICAL :: LLAK, LLPEAKF
!     LOGICAL FUNCTION
      LOGICAL :: LLALLOC_GRDFLD

      REAL ZHOOK_HANDLE

      IF (LHOOK) CALL DR_HOOK('OUTBS',0,ZHOOK_HANDLE)
!
! ----------------------------------------------------------------------
!*    1. COMPUTE MEAN PARAMETERS.
!        ------------------------

      CALL GSTATS(1951,0)

!     ALLOCATE THE NECESSARY ARRAYS

      IF(IPFGTBL(9).NE.0) THEN
        IF(.NOT.ALLOCATED(SMEAN)) ALLOCATE(SMEAN(IJS:IJL))
      ENDIF
      IF(IPFGTBL(25).NE.0) THEN
        IF(.NOT.ALLOCATED(P1MEAN)) ALLOCATE(P1MEAN(IJS:IJL))
      ENDIF
      IF(IPFGTBL(26).NE.0) THEN
        IF(.NOT.ALLOCATED(P2MEAN)) ALLOCATE(P2MEAN(IJS:IJL))
      ENDIF
      IF(IPFGTBL(27).NE.0) THEN
        IF(.NOT.ALLOCATED(SPRDMEAN)) ALLOCATE(SPRDMEAN(IJS:IJL))
      ENDIF
      IF(IPFGTBL(6) .NE.0 .OR.
     &   IPFGTBL(34).NE.0 .OR.
     &   IPFGTBL(35).NE.0 .OR.
     &   IPFGTBL(36).NE.0 .OR.
     &   IPFGTBL(38).NE.0 .OR.
     &   IPFGTBL(39).NE.0     ) THEN
        IF(.NOT.ALLOCATED(FPMEAN)) ALLOCATE(FPMEAN(IJS:IJL))
        IF(.NOT.ALLOCATED(C4MEAN)) ALLOCATE(C4MEAN(IJS:IJL))
        IF(.NOT.ALLOCATED(BFMEAN)) ALLOCATE(BFMEAN(IJS:IJL))
        IF(.NOT.ALLOCATED(QPMEAN)) ALLOCATE(QPMEAN(IJS:IJL))
        IF(.NOT.ALLOCATED(HMAXMEAN)) ALLOCATE(HMAXMEAN(IJS:IJL))
        IF(.NOT.ALLOCATED(TMAXMEAN)) ALLOCATE(TMAXMEAN(IJS:IJL))
      ENDIF
      IF(IPFGTBL(40).NE.0 .OR. IPFGTBL(41).NE.0) THEN
        IF(.NOT.ALLOCATED(USTMEAN)) ALLOCATE(USTMEAN(IJS:IJL))
        IF(.NOT.ALLOCATED(VSTMEAN)) ALLOCATE(VSTMEAN(IJS:IJL))
      ENDIF
      IF(IPFGTBL(56).NE.0) THEN
        IF(.NOT.ALLOCATED(STRNMS)) ALLOCATE(STRNMS(IJS:IJL))
      ENDIF

!     FOR THE EXTRA FIELDS
!     note that if the extra fields are forcing fields (i.e. already known) then
!     once can go directly to *outgrid* to pass then directly to the gridded
!     arrays (*G)
      IF(IPFGTBL(JPPFLAG-4).NE.0) THEN
        IF(.NOT.ALLOCATED(WX1)) ALLOCATE(WX1(IJS:IJL))
      ENDIF
      IF(IPFGTBL(JPPFLAG-3).NE.0) THEN
        IF(.NOT.ALLOCATED(WX2)) ALLOCATE(WX2(IJS:IJL))
      ENDIF
      IF(IPFGTBL(JPPFLAG-3).NE.0) THEN
        IF(.NOT.ALLOCATED(WX3)) ALLOCATE(WX3(IJS:IJL))
      ENDIF
      IF(IPFGTBL(JPPFLAG-1).NE.0) THEN
        IF(.NOT.ALLOCATED(WX4)) ALLOCATE(WX4(IJS:IJL))
      ENDIF
      IF(IPFGTBL(JPPFLAG).NE.0) THEN
        IF(.NOT.ALLOCATED(WX5)) ALLOCATE(WX5(IJS:IJL))
      ENDIF

!     COMPUTE MEAN PARAMETERS

      NPROMA=(IJL-IJS+1)/NWAM_BLKS+1


      LLAK=.FALSE.
      LLPEAKF = .FALSE.
      SIG = +1.
!$OMP PARALLEL DO SCHEDULE(DYNAMIC,1) PRIVATE(JKGLO,KIJS,KIJL)
      DO JKGLO=IJS,IJL,NPROMA
        KIJS=JKGLO
        KIJL=MIN(KIJS+NPROMA-1,IJL)

        IF(LSECONDORDER) THEN

          CALL CAL_SECOND_ORDER_SPEC(FL3(KIJS:KIJL,1:NANG,1:NFRE),
     &                             FL(KIJS:KIJL,1:NANG,1:NFRE),
     &                             KIJS,KIJL,
     &                             DEPTH(KIJS:KIJL,IG),INDEP(KIJS:KIJL),
     &                             SIG)
        ENDIF

        CALL FEMEAN (FL3(KIJS:KIJL,1:NANG,1:NFRE), KIJS, KIJL,
     &               EMEAN(KIJS), FMEAN(KIJS),LLAK)

        IF(IPFGTBL(2).NE.0) THEN
          CALL STHQ (FL3(KIJS:KIJL,1:NANG,1:NFRE),KIJS,KIJL,THQ(KIJS))
        ENDIF

        IF(IPFGTBL(9).NE.0) THEN
          CALL MEANSQS (FL3(KIJS:KIJL,1:NANG,1:NFRE),KIJS,KIJL,
     &                  USNEW(KIJS),FMEAN(KIJS),SMEAN(KIJS))
        ENDIF

        IF(IPFGTBL(25).NE.0) THEN
          CALL MWP1 (FL3(KIJS:KIJL,1:NANG,1:NFRE), KIJS, KIJL,
     &               EMEAN(KIJS), P1MEAN(KIJS))
        ENDIF
        IF(IPFGTBL(26).NE.0) THEN
          CALL MWP2 (FL3(KIJS:KIJL,1:NANG,1:NFRE), KIJS, KIJL,
     &               EMEAN(KIJS), P2MEAN(KIJS))
        ENDIF
        IF(IPFGTBL(27).NE.0) THEN
          CALL WDIRSPREAD (FL3(KIJS:KIJL,1:NANG,1:NFRE),
     &                     KIJS, KIJL, LLPEAKF, SPRDMEAN(KIJS))
        ENDIF
        IF(IPFGTBL(6) .NE.0 .OR.
     &     IPFGTBL(34).NE.0 .OR.
     &     IPFGTBL(35).NE.0 .OR.
     &     IPFGTBL(36).NE.0 .OR.
     &     IPFGTBL(38).NE.0 .OR.
     &     IPFGTBL(39).NE.0     ) THEN
          CALL KURTOSIS(FL3(KIJS:KIJL,1:NANG,1:NFRE),KIJS,KIJL,IG,
     &                  C4MEAN(KIJS),BFMEAN(KIJS),
     &                  QPMEAN(KIJS),FPMEAN(KIJS),HMAXMEAN(KIJS),
     &                  TMAXMEAN(KIJS))
        ENDIF

        IF(IPFGTBL(40).NE.0 .OR. IPFGTBL(41).NE.0) THEN
          CALL STOKESDRIFT(FL3(KIJS:KIJL,1:NANG,1:NFRE),
     &                     KIJS, KIJL, USTMEAN(KIJS), VSTMEAN(KIJS))
        ENDIF

        IF(IPFGTBL(56).NE.0) THEN
          CALL CIMSSTRN (FL3(KIJS:KIJL,1:NANG,1:NFRE),KIJS,KIJL,
     &                   STRNMS(KIJS))
        ENDIF

!       COMPUTE OUTPUT EXTRA FIELDS
!       add necessary code to compute the extra output fields
        IF(IPFGTBL(JPPFLAG-4).NE.0) THEN
          WX1(KIJS:KIJL)=1.0
        ENDIF
        IF(IPFGTBL(JPPFLAG-3).NE.0) THEN
          WX2(KIJS:KIJL)=2.0
        ENDIF
        IF(IPFGTBL(JPPFLAG-2).NE.0) THEN
          WX3(KIJS:KIJL)=3.0
        ENDIF
        IF(IPFGTBL(JPPFLAG-1).NE.0) THEN
          WX4(KIJS:KIJL)=4.0
        ENDIF
        IF(IPFGTBL(JPPFLAG).NE.0) THEN
          WX5(KIJS:KIJL)=5.0
        ENDIF

      ENDDO
!$OMP END PARALLEL DO


      IF (ITEST.GE.3) THEN
        IF (ITESTB.GE.IG) THEN
          WRITE(IU06,*) '      SUB. OUTBS: INTEGRATED',
     &     ' PARAMETERS COMPUTED FOR OUTPUT'
        ENDIF
      ENDIF

!*    2. WINDSEA SWELL SEPARATION.
!        -------------------------

      IF (CDTINTS.EQ.CDTPRO .OR. CDTSPS.EQ.CDTPRO) THEN

!       ALLOCATE THE NECESSARY ARRAYS
        IF(IPFGTBL(16).NE.0) THEN
          IF(.NOT.ALLOCATED(ESWELL)) ALLOCATE(ESWELL(IJS:IJL))
          IF(.NOT.ALLOCATED(FSWELL)) ALLOCATE(FSWELL(IJS:IJL))
        ENDIF
        IF(IPFGTBL(12).NE.0) THEN
          IF(.NOT.ALLOCATED(ESWELL)) ALLOCATE(ESWELL(IJS:IJL))
        ENDIF
        IF(IPFGTBL(14).NE.0) THEN
          IF(.NOT.ALLOCATED(THSWELL)) ALLOCATE(THSWELL(IJS:IJL))
        ENDIF
        IF(IPFGTBL(29).NE.0) THEN
          IF(.NOT.ALLOCATED(P1SWELL)) ALLOCATE(P1SWELL(IJS:IJL))
          IF(.NOT.ALLOCATED(ESWELL)) ALLOCATE(ESWELL(IJS:IJL))
        ENDIF
        IF(IPFGTBL(31).NE.0) THEN
          IF(.NOT.ALLOCATED(P2SWELL)) ALLOCATE(P2SWELL(IJS:IJL))
          IF(.NOT.ALLOCATED(ESWELL)) ALLOCATE(ESWELL(IJS:IJL))
        ENDIF
        IF(IPFGTBL(33).NE.0) THEN
          IF(.NOT.ALLOCATED(SPRDSWELL)) ALLOCATE(SPRDSWELL(IJS:IJL))
        ENDIF
        IF(IPFGTBL(15).NE.0) THEN
          IF(.NOT.ALLOCATED(ESEA)) ALLOCATE(ESEA(IJS:IJL))
          IF(.NOT.ALLOCATED(FSEA)) ALLOCATE(FSEA(IJS:IJL))
        ENDIF
        IF(IPFGTBL(11).NE.0) THEN
          IF(.NOT.ALLOCATED(ESEA)) ALLOCATE(ESEA(IJS:IJL))
        ENDIF
        IF(IPFGTBL(13).NE.0) THEN
          IF(.NOT.ALLOCATED(ESEA)) ALLOCATE(ESEA(IJS:IJL))
          IF(.NOT.ALLOCATED(THWISEA)) ALLOCATE(THWISEA(IJS:IJL))
        ENDIF
        IF(IPFGTBL(28).NE.0) THEN
          IF(.NOT.ALLOCATED(P1SEA)) ALLOCATE(P1SEA(IJS:IJL))
          IF(.NOT.ALLOCATED(ESEA)) ALLOCATE(ESEA(IJS:IJL))
        ENDIF
        IF(IPFGTBL(30).NE.0) THEN
          IF(.NOT.ALLOCATED(P2SEA)) ALLOCATE(P2SEA(IJS:IJL))
          IF(.NOT.ALLOCATED(ESEA)) ALLOCATE(ESEA(IJS:IJL))
        ENDIF
        IF(IPFGTBL(32).NE.0) THEN
          IF(.NOT.ALLOCATED(SPRDSEA)) ALLOCATE(SPRDSEA(IJS:IJL))
        ENDIF

!       COMPUTE MEAN PARAMETERS

!$OMP PARALLEL DO SCHEDULE(DYNAMIC,1) PRIVATE(JKGLO,KIJS,KIJL)
        DO JKGLO=IJS,IJL,NPROMA
          KIJS=JKGLO
          KIJL=MIN(KIJS+NPROMA-1,IJL)

          CALL SEPWISW (FL3(KIJS:KIJL,1:NANG,1:NFRE),
     &                  FL(KIJS:KIJL,1:NANG,1:NFRE),
     &                  KIJS, KIJL, THWOLD(KIJS:KIJL,IG),
     &                  USOLD(KIJS:KIJL,IG),USNEW(KIJS))
        ENDDO
!$OMP   END PARALLEL DO


        IF (ITEST.GE.3) THEN
          IF (ITESTB.GE.IG) THEN
            WRITE(IU06,*) '      SUB. OUTBS: SWELL /SEA',
     &       ' SEPARATION DONE'
          ENDIF
        ENDIF

      ENDIF



!*    3. 3 TRAINS SEPARATION.
!        -------------------------

      IF (CDTINTS.EQ.CDTPRO .OR. CDTSPS.EQ.CDTPRO) THEN
        IF(IPFGTBL(47) .NE.0 .OR.
     &     IPFGTBL(48).NE.0 .OR.
     &     IPFGTBL(49).NE.0 .OR.
     &     IPFGTBL(50).NE.0 .OR.
     &     IPFGTBL(51).NE.0 .OR.
     &     IPFGTBL(52).NE.0 .OR.
     &     IPFGTBL(53).NE.0 .OR.
     &     IPFGTBL(54).NE.0 .OR.
     &     IPFGTBL(55).NE.0     ) THEN

!         ALLOCATE THE NECESSARY ARRAYS
          IF(.NOT.ALLOCATED(ETRAIN1))  ALLOCATE(ETRAIN1(IJS:IJL))
          IF(.NOT.ALLOCATED(THTRAIN1)) ALLOCATE(THTRAIN1(IJS:IJL))
          IF(.NOT.ALLOCATED(P1TRAIN1)) ALLOCATE(P1TRAIN1(IJS:IJL))
          IF(.NOT.ALLOCATED(ETRAIN2))  ALLOCATE(ETRAIN2(IJS:IJL))
          IF(.NOT.ALLOCATED(THTRAIN2)) ALLOCATE(THTRAIN2(IJS:IJL))
          IF(.NOT.ALLOCATED(P1TRAIN2)) ALLOCATE(P1TRAIN2(IJS:IJL))
          IF(.NOT.ALLOCATED(ETRAIN3))  ALLOCATE(ETRAIN3(IJS:IJL))
          IF(.NOT.ALLOCATED(THTRAIN3)) ALLOCATE(THTRAIN3(IJS:IJL))
          IF(.NOT.ALLOCATED(P1TRAIN3)) ALLOCATE(P1TRAIN3(IJS:IJL))

!         COMPUTE MEAN WAVE TRAIN PARAMETERS

!$OMP PARALLEL DO SCHEDULE(DYNAMIC,1) PRIVATE(JKGLO,KIJS,KIJL)
          DO JKGLO=IJS,IJL,NPROMA
            KIJS=JKGLO
            KIJL=MIN(KIJS+NPROMA-1,IJL)

            CALL SEP3TR (FL3(KIJS:KIJL,1:NANG,1:NFRE),
     &                   KIJS, KIJL, USOLD(KIJS:KIJL,IG), 
     &                   THWOLD(KIJS:KIJL,IG))
          ENDDO
!$OMP   END PARALLEL DO

          IF (ITEST.GE.3) THEN
            IF (ITESTB.GE.IG) THEN
              WRITE(IU06,*) '      SUB. OUTBS: 3 TRAINS',
     &         ' SEPARATION DONE'
            ENDIF
          ENDIF
        ENDIF
      ENDIF

      CALL GSTATS(1951,1)

!*    4. OUTPUT OF SPECTRA AT SELECTED GRID POINTS.
!        ------------------------------------------

      IF (CDTSPT.EQ.CDTPRO .OR. CDTSPS.EQ.CDTPRO) THEN
        CALL OUTSPP (FL3, FL, IJS, IJL, IG, IU25)
        IF (ITEST.GE.3) THEN
          IF (ITESTB.GE.IG) THEN
            WRITE(IU06,*) '      SUB. OUTBS: OUTPUT OF SPECTRA',
     &       ' AT SELECTED POINTS DONE'
          ENDIF
        ENDIF
      ENDIF


!*    5. TRANSFER OF INTEGRATED PARAMETERS TO GRID ARRAYS.
!        -------------------------------------------------

!     ALLOCATE ARRAYS

      IF(IPFGTBL(1).NE.0) THEN
        IF(.NOT.ALLOCATED(WHGTTG)) THEN
          IF(LLALLOC_GRDFLD(1)) ALLOCATE(WHGTTG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(2).NE.0) THEN
        IF(.NOT.ALLOCATED(WDIRTG)) THEN
          IF(LLALLOC_GRDFLD(2)) ALLOCATE(WDIRTG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(3).NE.0) THEN
        IF(.NOT.ALLOCATED(WMNFTG)) THEN
          IF(LLALLOC_GRDFLD(3)) ALLOCATE(WMNFTG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(4).NE.0) THEN
        IF(.NOT.ALLOCATED(USTARG)) THEN
          IF(LLALLOC_GRDFLD(4)) ALLOCATE(USTARG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(5).NE.0) THEN
        IF(.NOT.ALLOCATED(UDIRG)) THEN
          IF(LLALLOC_GRDFLD(5))  ALLOCATE(UDIRG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(6).NE.0) THEN
        IF(.NOT.ALLOCATED(WPKFTG)) THEN
          IF(LLALLOC_GRDFLD(6)) ALLOCATE(WPKFTG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(7).NE.0) THEN
        IF(.NOT.ALLOCATED(CDG)) THEN
          IF(LLALLOC_GRDFLD(7)) ALLOCATE(CDG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(8).NE.0) THEN
        IF(.NOT.ALLOCATED(TAUWG)) THEN
          IF(LLALLOC_GRDFLD(8)) ALLOCATE(TAUWG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(9).NE.0) THEN
        IF(.NOT.ALLOCATED(SMEANG)) THEN
          IF(LLALLOC_GRDFLD(9)) ALLOCATE(SMEANG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(10).NE.0) THEN
        IF(.NOT.ALLOCATED(U10G)) THEN
          IF(LLALLOC_GRDFLD(10)) ALLOCATE(U10G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(11).NE.0) THEN
        IF(.NOT.ALLOCATED(WHGTWG)) THEN
          IF(LLALLOC_GRDFLD(11)) ALLOCATE(WHGTWG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(12).NE.0) THEN
        IF(.NOT.ALLOCATED(WHGTSG)) THEN
          IF(LLALLOC_GRDFLD(12)) ALLOCATE(WHGTSG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(13).NE.0) THEN
        IF(.NOT.ALLOCATED(WDIRWG)) THEN
          IF(LLALLOC_GRDFLD(13)) ALLOCATE(WDIRWG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(14).NE.0) THEN
        IF(.NOT.ALLOCATED(WDIRSG)) THEN
          IF(LLALLOC_GRDFLD(14)) ALLOCATE(WDIRSG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(15).NE.0) THEN
        IF(.NOT.ALLOCATED(WMNFWG)) THEN
          IF(LLALLOC_GRDFLD(15)) ALLOCATE(WMNFWG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(16).NE.0) THEN
        IF(.NOT.ALLOCATED(WMNFSG)) THEN
          IF(LLALLOC_GRDFLD(16)) ALLOCATE(WMNFSG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(22).NE.0) THEN
        IF(.NOT.ALLOCATED(WHGTAG)) THEN
          IF(LLALLOC_GRDFLD(22)) THEN
            ALLOCATE(WHGTAG(NGX,NGY))
            WHGTAG=0.
          ENDIF
        ENDIF
      ENDIF
      IF(IPFGTBL(23).NE.0) THEN
        IF(.NOT.ALLOCATED(CWHTAG)) THEN
          IF(LLALLOC_GRDFLD(23)) THEN
            ALLOCATE(CWHTAG(NGX,NGY))
            CWHTAG=0.
          ENDIF
        ENDIF
      ENDIF
      IF(IPFGTBL(24).NE.0) THEN
        IF(.NOT.ALLOCATED(RANGAG)) THEN
          IF(LLALLOC_GRDFLD(24)) THEN
            ALLOCATE(RANGAG(NGX,NGY))
            RANGAG=0.
          ENDIF
        ENDIF
      ENDIF
      IF(IPFGTBL(25).NE.0) THEN
        IF(.NOT.ALLOCATED(MWP1G)) THEN
          IF(LLALLOC_GRDFLD(25)) ALLOCATE(MWP1G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(26).NE.0) THEN
        IF(.NOT.ALLOCATED(MWP2G)) THEN
          IF(LLALLOC_GRDFLD(26)) ALLOCATE(MWP2G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(27).NE.0) THEN
        IF(.NOT.ALLOCATED(WSPRDG)) THEN
          IF(LLALLOC_GRDFLD(27)) ALLOCATE(WSPRDG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(28).NE.0) THEN
        IF(.NOT.ALLOCATED(MWP1WG)) THEN
          IF(LLALLOC_GRDFLD(28)) ALLOCATE(MWP1WG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(29).NE.0) THEN
        IF(.NOT.ALLOCATED(MWP1SG)) THEN
          IF(LLALLOC_GRDFLD(29)) ALLOCATE(MWP1SG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(30).NE.0) THEN
        IF(.NOT.ALLOCATED(MWP2WG)) THEN
          IF(LLALLOC_GRDFLD(30)) ALLOCATE(MWP2WG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(31).NE.0) THEN
        IF(.NOT.ALLOCATED(MWP2SG)) THEN
          IF(LLALLOC_GRDFLD(31)) ALLOCATE(MWP2SG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(32).NE.0) THEN
        IF(.NOT.ALLOCATED(WSPRDWG)) THEN
          IF(LLALLOC_GRDFLD(32)) ALLOCATE(WSPRDWG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(33).NE.0) THEN
        IF(.NOT.ALLOCATED(WSPRDSG)) THEN
          IF(LLALLOC_GRDFLD(33)) ALLOCATE(WSPRDSG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(34).NE.0) THEN
        IF(.NOT.ALLOCATED(C4G)) THEN
          IF(LLALLOC_GRDFLD(34)) ALLOCATE(C4G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(35).NE.0) THEN
        IF(.NOT.ALLOCATED(BFG)) THEN
          IF(LLALLOC_GRDFLD(35)) ALLOCATE(BFG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(36).NE.0) THEN
        IF(.NOT.ALLOCATED(QPG)) THEN
          IF(LLALLOC_GRDFLD(36)) ALLOCATE(QPG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(37).NE.0) THEN
        IF(.NOT.ALLOCATED(DEPTHG)) THEN
          IF(LLALLOC_GRDFLD(37)) ALLOCATE(DEPTHG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(38).NE.0) THEN
        IF(.NOT.ALLOCATED(HMAXG)) THEN
          IF(LLALLOC_GRDFLD(38)) ALLOCATE(HMAXG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(39).NE.0) THEN
        IF(.NOT.ALLOCATED(TMAXG)) THEN
          IF(LLALLOC_GRDFLD(39)) ALLOCATE(TMAXG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(40).NE.0 .OR. IPFGTBL(41).NE.0 ) THEN
        IF(.NOT.ALLOCATED(USTOKESG)) THEN
          IF(LLALLOC_GRDFLD(40)) ALLOCATE(USTOKESG(NGX,NGY))
        ENDIF
        IF(.NOT.ALLOCATED(VSTOKESG)) THEN
          IF(LLALLOC_GRDFLD(41)) ALLOCATE(VSTOKESG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(42).NE.0 .OR. IPFGTBL(43).NE.0 ) THEN
        IF(.NOT.ALLOCATED(UCURG)) THEN
          IF(LLALLOC_GRDFLD(42)) ALLOCATE(UCURG(NGX,NGY))
        ENDIF
        IF(.NOT.ALLOCATED(VCURG)) THEN
          IF(LLALLOC_GRDFLD(43)) ALLOCATE(VCURG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(44).NE.0) THEN
        IF(.NOT.ALLOCATED(PHIEPSG)) THEN
          IF(LLALLOC_GRDFLD(44)) ALLOCATE(PHIEPSG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(45).NE.0) THEN
        IF(.NOT.ALLOCATED(PHIAWG)) THEN
          IF(LLALLOC_GRDFLD(45)) ALLOCATE(PHIAWG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(46).NE.0) THEN
        IF(.NOT.ALLOCATED(TAUOCG)) THEN
          IF(LLALLOC_GRDFLD(46)) ALLOCATE(TAUOCG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(47).NE.0) THEN
        IF(.NOT.ALLOCATED(WHGTT1G)) THEN
          IF(LLALLOC_GRDFLD(47)) ALLOCATE(WHGTT1G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(48).NE.0) THEN
        IF(.NOT.ALLOCATED(WDIRT1G)) THEN
          IF(LLALLOC_GRDFLD(48)) ALLOCATE(WDIRT1G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(49).NE.0) THEN
        IF(.NOT.ALLOCATED(MWP1T1G)) THEN
          IF(LLALLOC_GRDFLD(49)) ALLOCATE(MWP1T1G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(50).NE.0) THEN
        IF(.NOT.ALLOCATED(WHGTT2G)) THEN
          IF(LLALLOC_GRDFLD(50)) ALLOCATE(WHGTT2G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(51).NE.0) THEN
        IF(.NOT.ALLOCATED(WDIRT2G)) THEN
          IF(LLALLOC_GRDFLD(51)) ALLOCATE(WDIRT2G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(52).NE.0) THEN
        IF(.NOT.ALLOCATED(MWP1T2G)) THEN
          IF(LLALLOC_GRDFLD(52)) ALLOCATE(MWP1T2G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(53).NE.0) THEN
        IF(.NOT.ALLOCATED(WHGTT3G)) THEN
          IF(LLALLOC_GRDFLD(53)) ALLOCATE(WHGTT3G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(54).NE.0) THEN
        IF(.NOT.ALLOCATED(WDIRT3G)) THEN
          IF(LLALLOC_GRDFLD(54)) ALLOCATE(WDIRT3G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(55).NE.0) THEN
        IF(.NOT.ALLOCATED(MWP1T3G)) THEN
          IF(LLALLOC_GRDFLD(55)) ALLOCATE(MWP1T3G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(56).NE.0) THEN
        IF(.NOT.ALLOCATED(STRNMSG)) THEN
          IF(LLALLOC_GRDFLD(56)) ALLOCATE(STRNMSG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(57).NE.0) THEN
        IF(.NOT.ALLOCATED(RHOAG)) THEN
          IF(LLALLOC_GRDFLD(57)) ALLOCATE(RHOAG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(58).NE.0) THEN
        IF(.NOT.ALLOCATED(WSTARG)) THEN
          IF(LLALLOC_GRDFLD(58)) ALLOCATE(WSTARG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(59).NE.0) THEN
        IF(.NOT.ALLOCATED(CICG)) THEN
          IF(LLALLOC_GRDFLD(59)) ALLOCATE(CICG(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(60).NE.0) THEN
        IF(.NOT.ALLOCATED(CIHG)) THEN
          IF(LLALLOC_GRDFLD(60)) ALLOCATE(CIHG(NGX,NGY))
        ENDIF
      ENDIF

      IF(IPFGTBL(JPPFLAG-4).NE.0) THEN
        IF(.NOT.ALLOCATED(WX1G)) THEN
          IF(LLALLOC_GRDFLD(JPPFLAG-4)) ALLOCATE(WX1G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(JPPFLAG-3).NE.0) THEN
        IF(.NOT.ALLOCATED(WX2G)) THEN
          IF(LLALLOC_GRDFLD(JPPFLAG-3)) ALLOCATE(WX2G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(JPPFLAG-2).NE.0) THEN
        IF(.NOT.ALLOCATED(WX3G)) THEN
          IF(LLALLOC_GRDFLD(JPPFLAG-2)) ALLOCATE(WX3G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(JPPFLAG-1).NE.0) THEN
        IF(.NOT.ALLOCATED(WX4G)) THEN
          IF(LLALLOC_GRDFLD(JPPFLAG-1)) ALLOCATE(WX4G(NGX,NGY))
        ENDIF
      ENDIF
      IF(IPFGTBL(JPPFLAG).NE.0) THEN
        IF(.NOT.ALLOCATED(WX5G)) THEN
          IF(LLALLOC_GRDFLD(JPPFLAG)) ALLOCATE(WX5G(NGX,NGY))
        ENDIF
      ENDIF

      CALL OUTGRID (IJS, IJL, IG)
      IF (ITEST.GE.3) THEN
        IF (ITESTB.GE.IG) THEN
          WRITE(IU06,*) '      SUB. OUTBS: OUTPUT OF ',
     &     'INTEGRATED PARAMETERS DONE'
          CALL FLUSH(IU06)
        ENDIF
      ENDIF

      IF(ALLOCATED(FPMEAN)) DEALLOCATE(FPMEAN)
      IF(ALLOCATED(SMEAN)) DEALLOCATE(SMEAN)
      IF(ALLOCATED(P1MEAN)) DEALLOCATE(P1MEAN)
      IF(ALLOCATED(P2MEAN)) DEALLOCATE(P2MEAN)
      IF(ALLOCATED(SPRDMEAN)) DEALLOCATE(SPRDMEAN)
      IF(ALLOCATED(C4MEAN)) DEALLOCATE(C4MEAN)
      IF(ALLOCATED(BFMEAN)) DEALLOCATE(BFMEAN)
      IF(ALLOCATED(QPMEAN)) DEALLOCATE(QPMEAN)
      IF(ALLOCATED(HMAXMEAN)) DEALLOCATE(HMAXMEAN)
      IF(ALLOCATED(TMAXMEAN)) DEALLOCATE(TMAXMEAN)
      IF(ALLOCATED(USTMEAN)) DEALLOCATE(USTMEAN)
      IF(ALLOCATED(VSTMEAN)) DEALLOCATE(VSTMEAN)
      IF(ALLOCATED(STRNMS)) DEALLOCATE(STRNMS)
      IF(ALLOCATED(WX1)) DEALLOCATE(WX1)
      IF(ALLOCATED(WX2)) DEALLOCATE(WX2)
      IF(ALLOCATED(WX3)) DEALLOCATE(WX3)
      IF(ALLOCATED(WX4)) DEALLOCATE(WX4)
      IF(ALLOCATED(WX5)) DEALLOCATE(WX5)

      IF (CDTINTS.EQ.CDTPRO .OR. CDTSPS.EQ.CDTPRO) THEN
        IF(ALLOCATED(ESWELL)) DEALLOCATE(ESWELL)
        IF(ALLOCATED(FSWELL)) DEALLOCATE(FSWELL)
        IF(ALLOCATED(THSWELL)) DEALLOCATE(THSWELL)
        IF(ALLOCATED(ESEA)) DEALLOCATE(ESEA)
        IF(ALLOCATED(FSEA)) DEALLOCATE(FSEA)
        IF(ALLOCATED(THWISEA)) DEALLOCATE(THWISEA)
        IF(ALLOCATED(P1SEA)) DEALLOCATE(P1SEA)
        IF(ALLOCATED(P2SEA)) DEALLOCATE(P2SEA)
        IF(ALLOCATED(SPRDSEA)) DEALLOCATE(SPRDSEA)
        IF(ALLOCATED(P1SWELL)) DEALLOCATE(P1SWELL)
        IF(ALLOCATED(P2SWELL)) DEALLOCATE(P2SWELL)
        IF(ALLOCATED(SPRDSWELL)) DEALLOCATE(SPRDSWELL)
        IF(ALLOCATED(ETRAIN1)) DEALLOCATE(ETRAIN1)
        IF(ALLOCATED(THTRAIN1)) DEALLOCATE(THTRAIN1)
        IF(ALLOCATED(P1TRAIN1)) DEALLOCATE(P1TRAIN1)
        IF(ALLOCATED(ETRAIN2)) DEALLOCATE(ETRAIN2)
        IF(ALLOCATED(THTRAIN2)) DEALLOCATE(THTRAIN2)
        IF(ALLOCATED(P1TRAIN2)) DEALLOCATE(P1TRAIN2)
        IF(ALLOCATED(ETRAIN3)) DEALLOCATE(ETRAIN3)
        IF(ALLOCATED(THTRAIN3)) DEALLOCATE(THTRAIN3)
        IF(ALLOCATED(P1TRAIN3)) DEALLOCATE(P1TRAIN3)
        IF (ITEST.GE.3) THEN
          IF (ITESTB.GE.IG) THEN
            WRITE(IU06,*) '      SUB. OUTBS: DEALLOCATE OF ARRAYS FOR',
     &       ' INTEGRATED PARAMETERS DONE'
            CALL FLUSH(IU06)
          ENDIF
        ENDIF
      ENDIF

!*    6. OUTPUT OF SPECTRA FOR SATELLITE COLLOCATION.
!        --------------------------------------------

      IF (MARSTYPE.EQ.'an'.OR.MARSTYPE.EQ.'fg'.OR.MARSTYPE.EQ.'4v') THEN
        IF (CDTPRO.NE.CDATEA) THEN
          CALL OUTERS (FL3, IG, IGL, CDTPRO)
          IF (ITEST.GE.3) THEN
            IF (ITESTB.GE.IG) THEN
              WRITE(IU06,*) '      SUB. OUTBS: OUTPUT OF SPECTRA',
     &         ' FOR SATELLITE COLLOCATION DONE FOR ', CDTPRO
            ENDIF
          ENDIF
        ENDIF
      ENDIF
      IF (LHOOK) CALL DR_HOOK('OUTBS',1,ZHOOK_HANDLE)

      RETURN
      END SUBROUTINE OUTBS
